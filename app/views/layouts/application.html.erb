<!DOCTYPE html>
<html>
	<head>
		<title><% if current_page?('/') %>The Spain Report | Understand Spain, In English<% else %><%= yield(:title) %> | The Spain Report<% end %></title>
		<%= yield(:meta) %>
		<%= favicon_link_tag %>
		<%= stylesheet_link_tag "https://fonts.googleapis.com/css?family=Anton:400", media: "all" %>
		<%= csrf_meta_tags %>
		<%= csp_meta_tag %>
		<%= stylesheet_link_tag    'application', media: 'all'%>
		<%= javascript_include_tag 'application' %>
		
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="alternate" type="application/rss+xml" title="The Spain Report: English + Spanish" href="<%= root_url + 'rss' %>" />
		<link rel="alternate" type="application/rss+xml" title="The Spain Report: in English" href="<%= root_url + 'rss/eng' %>" />
		<link rel="alternate" type="application/rss+xml" title="The Spain Report: en espaÃ±ol" href="<%= root_url + 'rss/es' %>" />
		
		<% if controller_name == "payments" %>
			<script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
			<script type="text/javascript">
				var onSuccess = function(x){
					var country_code = x.country.iso_code;
					var ip = x.traits.ip_address;
					var country_name = x.country.names.en;
				  	var country_flags = {};
						<% Country.all.each do |c| %>
							country_flags["<%= c.country_code %>"] = {image: '<%= asset_path(c.country_code + '.jpg') %>', tax_percent: <%= c.tax_percent %>}
						<% end %>
							country_flags["UN"] = {image: '<%= asset_path('UN.jpg') %>', tax_percent: 0.0}
	
					document.getElementById('ip_address').innerHTML = ip;
					document.getElementById('ip_address_for_server').value = ip;
					document.getElementById('country_code').innerHTML = country_code;
					document.getElementById('country_code_for_server').value = country_code;
					
					if(country_flags.hasOwnProperty(country_code)) {
						document.getElementById('vat_rate').innerHTML = country_flags[country_code].tax_percent.toFixed(1) + "%";
						document.getElementById('vat_rate_for_server').value = country_flags[country_code].tax_percent.toFixed(1);
						document.getElementById('country_flag').src = country_flags[country_code].image;
					} else {
						document.getElementById('vat_rate').innerHTML = country_flags["UN"].tax_percent.toFixed(1) + "%";
						document.getElementById('vat_rate_for_server').value = country_flags["UN"].tax_percent.toFixed(1) + "%";
						document.getElementById('country_flag').src = country_flags["UN"].image;
					}
 		
					function preciseTaxes( num, precision ) {
					    return (+(Math.round(+(num + 'e' + precision)) + 'e' + -precision)).toFixed(precision);
					}
	
					var PlanAmount = parseFloat(<%= @amount %>);
					var VatRate = parseFloat(country_flags[country_code].tax_percent) / 100;
					var VatAmount = parseFloat(PlanAmount * VatRate);
				    var TotalAmount = parseFloat(PlanAmount + VatAmount);
					
					document.getElementById('plan_amount').innerHTML = preciseTaxes(PlanAmount, 2);
					document.getElementById('plan_amount_for_server').value = preciseTaxes(PlanAmount, 2);
					document.getElementById('vat_amount').innerHTML = preciseTaxes(VatAmount, 2);
					document.getElementById('vat_amount_for_server').value = preciseTaxes(VatAmount, 2);
					document.getElementById('total_amount').innerHTML = preciseTaxes(TotalAmount, 2);
					document.getElementById('total_amount_for_server').value = Math.round(preciseTaxes(TotalAmount, 2)*100);
				};
				
			var onError = function(error){
			  alert(
			      "Error:\n\n"
			      + JSON.stringify(error, undefined, 4)
			  );
			};
			
			geoip2.country(onSuccess, onError);
			
			function readyServer() { 
			 		document.getElementById("email_for_server").value = document.getElementById("customer_email").value; 
			 	}
			</script>
		<% else end %>

	</head>

	<body>
		
		<%= yield %>
	</body>

</html>