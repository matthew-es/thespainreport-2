<!DOCTYPE html>
<html>
	<head>
		<title><% if current_page?('/') %>The Spain Report | Understand Spain, In English<% else %><%= yield(:title) %> | The Spain Report<% end %></title>
		<%= yield(:meta) %>
		<%= favicon_link_tag %>
		<%= stylesheet_link_tag "https://fonts.googleapis.com/css?family=Anton:400", media: "all" %>
		<%= csrf_meta_tags %>
		<%= csp_meta_tag %>
		<%= stylesheet_link_tag    'application', media: 'all'%>
		<%= javascript_include_tag 'application' %>
		
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="alternate" type="application/rss+xml" title="The Spain Report: English + Spanish" href="<%= root_url + 'rss' %>" />
		<link rel="alternate" type="application/rss+xml" title="The Spain Report: in English" href="<%= root_url + 'rss/eng' %>" />
		<link rel="alternate" type="application/rss+xml" title="The Spain Report: en español" href="<%= root_url + 'rss/es' %>" />
		
		<% if controller_name == "payments" %>
			<script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
			<script type="text/javascript">
				var country_flags = {};
						<% Country.all.each do |c| %>
							country_flags["<%= c.country_code %>"] = {image: '<%= asset_path(c.country_code + '.jpg') %>'}
						<% end %>
							country_flags["UN"] = {image: '<%= asset_path('UN.jpg') %>'}
				
				function preciseTaxes( num, precision ) {
					    return (+(Math.round(+(num + 'e' + precision)) + 'e' + -precision)).toFixed(precision);
					}
							
				var onSuccess = function(x){
					var ip_country_code = x.country.iso_code;
					var ip = x.traits.ip_address;
	
				
					document.getElementById('ip_address_for_server').value = ip;
					document.getElementById('ip_country_code_for_server').value = ip_country_code;
					document.getElementById('select_residence_country').options[ip_country_code].selected = true;
					
					window.ip_country_code = ip_country_code;
				};
				var onError = function(error){
				  alert(
				      "Error:\n\n"
				      + JSON.stringify(error, undefined, 4)
				  );
				};
				geoip2.country(onSuccess, onError);
				
				function initialAmount() {
					var setup_amount = 2500;
					
					document.getElementById("plan_amount_for_server").value = setup_amount;
					document.getElementById("plan_amount").innerHTML = preciseTaxes(parseFloat(setup_amount/100), 2);
				}
				
				function setAmount(clicked_value) {
					var setup_amount = parseFloat(clicked_value/100);
					
					document.getElementById("plan_amount").innerHTML = preciseTaxes(setup_amount, 2);
					document.getElementById("plan_amount_for_server").value = clicked_value;
				}
				
				function setEmail() { 
				 		document.getElementById("email_for_server").value = document.getElementById("customer_email").value; 
				 	}
				
				function changeResidence() {
						var select_country = document.getElementById('select_residence_country').value;
						document.getElementById('residence_country_code_for_server').value = select_country;
						document.getElementById('residence_country_flag').src = country_flags[select_country].image;
					}
				
				function getSetup() {
				  var xhttp = new XMLHttpRequest();
				  xhttp.onreadystatechange = function() {
				    if (this.readyState == 4 && this.status == 200) {
				     document.getElementById("card-button").setAttribute("data-secret", this.responseText);
				     document.getElementById("customer_email").onfocus = null;
				     document.getElementById("card-element").onmouseover = null;
				    }
				  };
				  xhttp.open("GET", "/ajax_test", true);
				  xhttp.send();
				}
				
				function confirmFirstpayment() {
					var e = 'matthew@thespainreport.com';
 					var at = document.getElementById("authenticity_token").value;
 					var ta = document.getElementById("total_amount").value;
 					var string_for_server = 
 					'email_for_server=' + e
 					+ '&authenticity_token=' + at
 					+ '&total_amount=' + ta;
 					
 				
					var xhttp = new XMLHttpRequest();
					  xhttp.onreadystatechange = function() {
					    if (this.readyState == 1 || 2 || 3) {
					    	document.getElementById("ajax_message").style.display = "block";
					    	document.getElementById("ajax_message").innerHTML = "Confirming payment…";
					    }
					    
					    if (this.readyState == 4 && this.status == 200) {
					     console.log(this.responseText)
					     var details = JSON.parse(this.responseText)
					     document.getElementById("ajax_step_1").style.display = "none";
					     document.getElementById("ajax_message").style.display = "none";
					     document.getElementById("ajax_confirm").style.display = "none";
					     document.getElementById("ajax_welcome").style.display = "block";
					     document.getElementById("ajax_welcome").innerHTML = "Welcome aboard…!";
					    }
					  };
	 				xhttp.open("POST", "/stripe_first_payment", true);
					xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					xhttp.setRequestHeader('X-CSRF-TOKEN', at);
					xhttp.send(string_for_server);
				}
				
				window.addEventListener('load', function () {    
				   	initialAmount();
				   	setEmail();
					changeResidence();
				}, false);
			
				
			</script>
		<% else end %>

	</head>

	<body>
		
		<%= yield %>
	</body>

</html>